{"version":3,"file":"totp_refresh.min.js","sources":["../src/totp_refresh.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TOTP auto-refresh JavaScript module\n *\n * @module     local_totp/totp_refresh\n * @copyright  2025, Lo√Øc CRAMPON <loic.crampon@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax'], function($, Ajax) {\n    'use strict';\n\n    var courseId = 0;\n    var period = 30;\n    var circumference = 691;\n    var remainingSeconds = 0;\n\n    /**\n     * Update the TOTP display\n     */\n    var updateTotp = function() {\n        var promises = Ajax.call([{\n            methodname: 'local_totp_get_totp',\n            args: {courseid: courseId}\n        }]);\n\n        promises[0].done(function(response) {\n            $('#totp-code').text(response.totp);\n            remainingSeconds = response.remaining;\n            $('#totp-remaining').text(remainingSeconds);\n\n            // Reset progress to 100% instantly (no transition) for new TOTP.\n            var $circle = $('#totp-progress-circle');\n            $circle.css('transition', 'none');\n            $circle.css('stroke-dashoffset', 0);\n\n            // Re-enable transition after a short delay.\n            setTimeout(function() {\n                $circle.css('transition', 'stroke-dashoffset 1s linear');\n            }, 50);\n        }).fail(function(ex) {\n            // eslint-disable-next-line no-console\n            console.error('Failed to refresh TOTP:', ex);\n        });\n    };\n\n    /**\n     * Update the circular progress bar\n     */\n    var updateProgress = function() {\n        var fraction = remainingSeconds / period;\n        var offset = circumference - (fraction * circumference);\n        $('#totp-progress-circle').css('stroke-dashoffset', offset);\n    };\n\n    /**\n     * Countdown timer\n     */\n    var countdown = function() {\n        remainingSeconds--;\n        if (remainingSeconds < 0) {\n            remainingSeconds = period;\n            updateTotp();\n        } else {\n            $('#totp-remaining').text(remainingSeconds);\n            updateProgress();\n        }\n    };\n\n    /**\n     * Initialize the TOTP refresh module\n     *\n     * @param {number} cid Course ID\n     * @param {number} p Period in seconds\n     * @param {number} circ Circle circumference\n     */\n    var init = function(cid, p, circ) {\n        courseId = cid;\n        period = p;\n        circumference = circ;\n        remainingSeconds = parseInt($('#totp-remaining').text());\n\n        // Update countdown every second.\n        setInterval(countdown, 1000);\n    };\n\n    return {\n        init: init\n    };\n});\n"],"names":["define","$","Ajax","courseId","period","circumference","remainingSeconds","countdown","offset","call","methodname","args","courseid","done","response","text","totp","remaining","$circle","css","setTimeout","fail","ex","console","error","init","cid","p","circ","parseInt","setInterval"],"mappings":";;;;;;;AAuBAA,iCAAO,CAAC,SAAU,cAAc,SAASC,EAAGC,UAGpCC,SAAW,EACXC,OAAS,GACTC,cAAgB,IAChBC,iBAAmB,EA2CnBC,UAAY,WATK,IAEbC,SAQJF,iBACuB,GACnBA,iBAAmBF,OAxCRF,KAAKO,KAAK,CAAC,CACtBC,WAAY,sBACZC,KAAM,CAACC,SAAUT,aAGZ,GAAGU,MAAK,SAASC,UACtBb,EAAE,cAAcc,KAAKD,SAASE,MAC9BV,iBAAmBQ,SAASG,UAC5BhB,EAAE,mBAAmBc,KAAKT,sBAGtBY,QAAUjB,EAAE,yBAChBiB,QAAQC,IAAI,aAAc,QAC1BD,QAAQC,IAAI,oBAAqB,GAGjCC,YAAW,WACPF,QAAQC,IAAI,aAAc,iCAC3B,OACJE,MAAK,SAASC,IAEbC,QAAQC,MAAM,0BAA2BF,SAsBzCrB,EAAE,mBAAmBc,KAAKT,kBAb1BE,OAASH,cADEC,iBAAmBF,OACOC,cACzCJ,EAAE,yBAAyBkB,IAAI,oBAAqBX,gBAkCjD,CACHiB,KAXO,SAASC,IAAKC,EAAGC,MACxBzB,SAAWuB,IACXtB,OAASuB,EACTtB,cAAgBuB,KAChBtB,iBAAmBuB,SAAS5B,EAAE,mBAAmBc,QAGjDe,YAAYvB,UAAW"}